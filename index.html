
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>1νμ© μ΄λ―Έμ§€ μ•”νΈν™”κΈ° (jsonbin.io)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      background: #f5f5f5;
      padding: 2rem;
    }
    input, button, textarea {
      width: 100%;
      margin: 0.5rem 0;
      padding: 0.5rem;
    }
    img {
      max-width: 100%;
      margin-top: 1rem;
      display: block;
    }
    .section {
      margin-bottom: 2rem;
    }
    #copyBtn {
      margin-top: 0.3rem;
      background-color: #444;
      color: white;
    }
  </style>
</head>
<body>

<h2>π” μ΄λ―Έμ§€ μ•”νΈν™” & 1νμ© λ³µνΈν™”</h2>

<div class="section">
  <h3>β‘  μ•”νΈν™”</h3>
  <input type="file" accept="image/*" id="imgInput">
  <input type="password" id="keyInput" placeholder="μ•”νΈν‚¤ μ…λ ¥" value="3">
  <button onclick="encryptAndUpload()">μ•”νΈν™” & μ—…λ΅λ“</button>
  <input type="text" id="generatedId" readonly placeholder="μ•”νΈ ID">
  <button id="copyBtn" onclick="copyId()">μ•”νΈID λ³µμ‚¬</button>
</div>

<hr>

<div class="section">
  <h3>β‘΅ λ³µνΈν™”</h3>
  <input type="text" id="readId" placeholder="μ•”νΈ ID μ…λ ¥">
  <input type="password" id="decryptKey" placeholder="μ•”νΈν‚¤ μ…λ ¥" value="3">
  <button onclick="fetchAndDecrypt()">λ³µνΈν™”</button>
  <div id="imagePreview"></div>
</div>

<script>
const API_KEY = "$2a$10$aNAOYbgwIXOANtewNpSn7.vCnX3YC4Bbl6LfzYnSon4YMWmoGCTZC"; // μ: "eyJhbGciOiJIUzI1NiIs..."
const BIN_URL = "https://api.jsonbin.io/v3/b";

// μ•”νΈν™” + μ—…λ΅λ“
function encryptAndUpload() {
  const file = document.getElementById('imgInput').files[0];
  const key = document.getElementById('keyInput').value;

  if (!file || !key) return alert("μ΄λ―Έμ§€μ™€ μ•”νΈν‚¤λ¥Ό μ…λ ¥ν•μ„Έμ”.");

  const reader = new FileReader();
  reader.onload = function (e) {
    const base64 = e.target.result;
    const encrypted = CryptoJS.AES.encrypt(base64, key).toString();

    fetch(BIN_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Master-Key": API_KEY,
        "X-Bin-Private": true
      },
      body: JSON.stringify({ encrypted })
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById('generatedId').value = data.metadata.id;
      alert("β… μ—…λ΅λ“ μ™„λ£! μ•”νΈ IDκ°€ μƒμ„±λμ—μµλ‹λ‹¤.");
    })
    .catch(err => alert("β μ—…λ΅λ“ μ‹¤ν¨: " + err));
  };
  reader.readAsDataURL(file);
}

// λ³µνΈν™” + μ‚­μ 
function fetchAndDecrypt() {
  const id = document.getElementById('readId').value.trim();
  const key = document.getElementById('decryptKey').value;
  const imageBox = document.getElementById('imagePreview');

  if (!id || !key) return alert("IDμ™€ μ•”νΈν‚¤λ¥Ό μ…λ ¥ν•μ„Έμ”.");

  fetch(`${BIN_URL}/${id}/latest`, {
    headers: { "X-Master-Key": API_KEY }
  })
  .then(res => res.json())
  .then(data => {
    const encrypted = data.record.encrypted;
    const bytes = CryptoJS.AES.decrypt(encrypted, key);
    const decrypted = bytes.toString(CryptoJS.enc.Utf8);

    if (!decrypted.startsWith("data:image")) throw new Error("Invalid content");

    const img = new Image();
    img.src = decrypted;
    imageBox.innerHTML = "";
    imageBox.appendChild(img);

    // μλ™ μ‚­μ 
    fetch(`${BIN_URL}/${id}`, {
      method: "DELETE",
      headers: { "X-Master-Key": API_KEY }
    });
  })
  .catch(err => alert("β λ³µνΈν™” μ‹¤ν¨ λλ” μ΅΄μ¬ν•μ§€ μ•λ” ID"));
}

// λ³µμ‚¬ λ²„νΌ
function copyId() {
  const id = document.getElementById("generatedId").value;
  navigator.clipboard.writeText(id);
}
</script>

</body>
</html>
