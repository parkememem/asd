
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>1회용 이미지 암호화기 (jsonbin.io)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 2rem auto;
      background: #f5f5f5;
      padding: 2rem;
    }
    input, button, textarea {
      width: 100%;
      margin: 0.5rem 0;
      padding: 0.5rem;
    }
    img {
      max-width: 100%;
      margin-top: 1rem;
      display: block;
    }
    .section {
      margin-bottom: 2rem;
    }
    #copyBtn {
      margin-top: 0.3rem;
      background-color: #444;
      color: white;
    }
  </style>
</head>
<body>

<h2>🔐 이미지 암호화 & 1회용 복호화</h2>

<div class="section">
  <h3>① 암호화</h3>
  <input type="file" accept="image/*" id="imgInput">
  <input type="password" id="keyInput" placeholder="암호키 입력" value="3">
  <button onclick="encryptAndUpload()">암호화 & 업로드</button>
  <input type="text" id="generatedId" readonly placeholder="암호 ID">
  <button id="copyBtn" onclick="copyId()">암호ID 복사</button>
</div>

<hr>

<div class="section">
  <h3>② 복호화</h3>
  <input type="text" id="readId" placeholder="암호 ID 입력">
  <input type="password" id="decryptKey" placeholder="암호키 입력" value="3">
  <button onclick="fetchAndDecrypt()">복호화</button>
  <div id="imagePreview"></div>
</div>

<script>
const API_KEY = "$2a$10$aNAOYbgwIXOANtewNpSn7.vCnX3YC4Bbl6LfzYnSon4YMWmoGCTZC"; // 예: "eyJhbGciOiJIUzI1NiIs..."
const BIN_URL = "https://api.jsonbin.io/v3/b";

// 암호화 + 업로드
function encryptAndUpload() {
  const file = document.getElementById('imgInput').files[0];
  const key = document.getElementById('keyInput').value;

  if (!file || !key) return alert("이미지와 암호키를 입력하세요.");

  const reader = new FileReader();
  reader.onload = function (e) {
    const base64 = e.target.result;
    const encrypted = CryptoJS.AES.encrypt(base64, key).toString();

    fetch(BIN_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Master-Key": API_KEY,
        "X-Bin-Private": true
      },
      body: JSON.stringify({ encrypted })
    })
    .then(res => res.json())
    .then(data => {
      document.getElementById('generatedId').value = data.metadata.id;
      alert("✅ 업로드 완료! 암호 ID가 생성되었습니다.");
    })
    .catch(err => alert("❌ 업로드 실패: " + err));
  };
  reader.readAsDataURL(file);
}

// 복호화 + 삭제
function fetchAndDecrypt() {
  const id = document.getElementById('readId').value.trim();
  const key = document.getElementById('decryptKey').value;
  const imageBox = document.getElementById('imagePreview');

  if (!id || !key) return alert("ID와 암호키를 입력하세요.");

  fetch(`${BIN_URL}/${id}/latest`, {
    headers: { "X-Master-Key": API_KEY }
  })
  .then(res => res.json())
  .then(data => {
    const encrypted = data.record.encrypted;
    const bytes = CryptoJS.AES.decrypt(encrypted, key);
    const decrypted = bytes.toString(CryptoJS.enc.Utf8);

    if (!decrypted.startsWith("data:image")) throw new Error("Invalid content");

    const img = new Image();
    img.src = decrypted;
    imageBox.innerHTML = "";
    imageBox.appendChild(img);

    // 자동 삭제
    fetch(`${BIN_URL}/${id}`, {
      method: "DELETE",
      headers: { "X-Master-Key": API_KEY }
    });
  })
  .catch(err => alert("❌ 복호화 실패 또는 존재하지 않는 ID"));
}

// 복사 버튼
function copyId() {
  const id = document.getElementById("generatedId").value;
  navigator.clipboard.writeText(id);
}
</script>

</body>
</html>
